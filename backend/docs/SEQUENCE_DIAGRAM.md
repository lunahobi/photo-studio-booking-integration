# Диаграмма последовательности

## Сценарий: Создание бронирования и оплата

```
Клиент          API Gateway    Booking Service   Payment Service   Платежный шлюз   Message Broker   Integration Service   Notification Service
   │                  │              │                  │                  │                │                    │                      │
   │  1. GET /availability          │                  │                  │                │                    │                      │
   ├───────────────────>            │                  │                  │                │                    │                      │
   │                  ├────────────>│                  │                  │                │                    │                      │
   │                  │             │   Проверка       │                  │                │                    │                      │
   │                  │             │   доступности    │                  │                │                    │                      │
   │                  │<────────────┤                  │                  │                │                    │                      │
   │<───────────────────┤            │                  │                  │                │                    │                      │
   │                  │              │                  │                  │                │                    │                      │
   │  2. POST /bookings             │                  │                  │                │                    │                      │
   ├───────────────────>            │                  │                  │                │                    │                      │
   │                  ├────────────>│                  │                  │                │                    │                      │
   │                  │             │   Создание       │                  │                │                    │                      │
   │                  │             │   бронирования   │                  │                │                    │                      │
   │                  │             │                  │                  │                │                    │                      │
   │                  │             │  3. publish(booking.created)       │                │                    │                      │
   │                  │             ├────────────────────────────────────>                │                    │                      │
   │                  │             │                  │                  │                │                    │                      │
   │                  │             │                  │                  │    4. route event│                    │                      │
   │                  │             │                  │                  │<─────────────────┴─────────────────────┤                      │
   │                  │             │                  │                  │                │                    │                      │
   │                  │             │                  │                  │    5. route event│                      │
   │                  │             │                  │                  │<─────────────────────────────────────────────────────────────┤
   │                  │             │                  │                  │                │                    │                      │
   │                  │<────────────┤                  │                  │                │                    │                      │
   │<───────────────────┤            │                  │                  │                │                    │                      │
   │                  │              │                  │                  │                │                    │                      │
   │  6. POST /payments             │                  │                  │                │                    │                      │
   ├───────────────────>            │                  │                  │                │                    │                      │
   │                  │             │                  ├──────────────────>                │                    │                      │
   │                  │             │                  │   Создание       │                │                    │                      │
   │                  │             │                  │   платежа        │                │                    │                      │
   │                  │             │                  │                  │                │                    │                      │
   │                  │             │                  │   7. redirect    │                │                    │                      │
   │                  │             │                  ├──────────────────>                │                    │                      │
   │                  │             │                  │                  │                │                    │                      │
   │                  │<────────────┴──────────────────┴──────────────────┴────────────────┘                    │                      │
   │<───────────────────┤            │                  │                  │                │                    │                      │
   │                  │              │                  │                  │                │                    │                      │
   │  8. Оплата (на стороне платежного шлюза)          │                  │                │                    │                      │
   │─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│
   │                  │              │                  │                  │                │                    │                      │
   │                  │              │                  │   9. Webhook     │                │                    │                      │
   │                  │              │                  │<─────────────────┤                │                    │                      │
   │                  │              │                  │                  │                │                    │                      │
   │                  │              │                  │ 10. publish(payment.succeeded)    │                    │                      │
   │                  │              │                  ├────────────────────────────────────>                │                    │                      │
   │                  │              │                  │                  │                │                    │                      │
   │                  │              │  11. confirm booking                │                │                    │                      │
   │                  │              │<─────────────────┘                  │                │                    │                      │
   │                  │              │                                     │                │                    │                      │
   │                  │              │ 12. publish(booking.confirmed)     │                │                    │                      │
   │                  │              ├────────────────────────────────────>                │                    │                      │
   │                  │              │                                     │    13. route events│                    │                      │
   │                  │              │                                     │<─────────────────┴─────────────────────┤                      │
   │                  │              │                                     │                │                    │                      │
   │                  │              │                                     │    14. route event│                      │
   │                  │              │                                     │<─────────────────────────────────────────────────────────────┤
   │                  │              │                                     │                │                    │                      │
```

## Описание шагов

1. **Проверка доступности**: Клиент запрашивает доступные слоты для бронирования
2. **Создание бронирования**: Клиент создает новое бронирование
3. **Событие создания бронирования**: Booking Service публикует событие `booking.created`
4. **Маршрутизация в Integration Service**: Message Broker доставляет событие в Integration Service
5. **Маршрутизация в Notification Service**: Message Broker доставляет событие в Notification Service для отправки уведомления
6. **Создание платежа**: Клиент инициирует платеж
7. **Редирект на оплату**: Payment Service возвращает URL для редиректа на платежный шлюз
8. **Оплата**: Клиент выполняет оплату на стороне платежного шлюза
9. **Webhook**: Платежный шлюз отправляет webhook о статусе платежа
10. **Событие успешной оплаты**: Payment Service публикует событие `payment.succeeded`
11. **Подтверждение бронирования**: Payment Service уведомляет Booking Service о подтверждении
12. **Событие подтверждения бронирования**: Booking Service публикует событие `booking.confirmed`
13. **Маршрутизация событий**: Message Broker доставляет события в Integration Service и Notification Service

## Обработка ошибок

Если на любом этапе возникает ошибка:

1. **Ошибка создания бронирования**: Возвращается HTTP 400/500, событие не публикуется
2. **Ошибка платежа**: Публикуется событие `payment.failed`, бронирование остается в статусе `pending_payment`
3. **Ошибка доставки события**: Message Broker повторяет попытку доставки (до 3 раз)
4. **Ошибка webhook**: Payment Service логирует ошибку, статус платежа остается `pending`

