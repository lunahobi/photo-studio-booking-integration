# Архитектура системы

## Обзор

Система построена на микросервисной архитектуре с событийно-ориентированными интеграциями и API Gateway.

## Компоненты

### 1. API Gateway (порт 5000)
- Центральная точка входа для всех клиентов
- Маршрутизация запросов к соответствующим сервисам
- В будущем: аутентификация, авторизация, rate limiting

### 2. Booking Service (порт 5001)
- Управление бронированиями
- Календарь доступности залов (шаг 15 минут)
- Расчет стоимости бронирования
- Публикация событий: `booking.created`, `booking.confirmed`, `booking.cancelled`

### 3. Payment Service (порт 5002)
- Обработка платежей
- Интеграция с платежными шлюзами (ЮKassa, СберPay, Тинькофф Касса)
- Обработка webhook от платежных шлюзов
- Публикация событий: `payment.succeeded`, `payment.failed`

### 4. Integration Service (порт 5003)
- Обработка событий от других сервисов
- Синхронизация данных
- Логирование событий
- В будущем: интеграция с внешними системами (CRM, аналитика)

### 5. Notification Service (порт 5004)
- Отправка email уведомлений
- Отправка SMS уведомлений
- Обработка событий для отправки уведомлений

### 6. Message Broker (порт 5050)
- Централизованная обработка событий
- Маршрутизация сообщений к подписчикам
- Очереди для различных типов событий

## Потоки данных

### Создание бронирования

```
Клиент → API Gateway → Booking Service
                          ↓
                   Message Broker
                          ↓
         ┌────────────────┴────────────────┐
         ↓                                  ↓
  Integration Service          Notification Service
```

### Обработка платежа

```
Клиент → API Gateway → Payment Service → Платежный шлюз
                          ↑                    │
                          │                    ↓
                   Webhook ←───────────────────┘
                          ↓
                   Message Broker
                          ↓
         ┌────────────────┴────────────────┐
         ↓                                  ↓
  Integration Service          Notification Service
         ↓
  Booking Service (подтверждение бронирования)
```

## Схема данных

Основные сущности:
- **User** - пользователи системы
- **Hall** - залы фотостудии
- **Booking** - бронирования
- **Payment** - платежи
- **Tariff** - тарифы

Подробная схема БД в файле `database/schema.sql`

## Форматы обмена данными

- **REST API**: JSON формат
- **События**: JSON через Message Broker
- **База данных**: PostgreSQL с поддержкой JSONB для метаданных

## Контракты (схемы данных)

Все схемы определены в модуле `schemas/`:
- `schemas/booking.py` - схемы для бронирований
- `schemas/payment.py` - схемы для платежей
- `schemas/integration.py` - схемы для интеграций

Используется библиотека Pydantic для валидации данных.

## Обработка ошибок

- Все сервисы возвращают стандартные HTTP коды статуса
- Ошибки логируются и могут быть отслежены через Integration Service
- Message Broker обеспечивает гарантированную доставку сообщений с повторными попытками

## Масштабируемость

- Каждый сервис может масштабироваться независимо
- Message Broker позволяет обрабатывать асинхронные задачи
- Stateless сервисы позволяют легко добавлять инстансы

